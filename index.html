<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Chess Activity ‚Äì Friends Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
    }

    h1 {
      margin: 0;
      font-size: 2rem;
      text-align: center;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 0.9rem;
      text-align: center;
    }

    main {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      width: 100%;
    }

    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 1rem;
      padding: 1.2rem 1.4rem;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .username {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .badge {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge.active {
      background: #065f46;
      color: #bbf7d0;
    }

    .badge.inactive {
      background: #7f1d1d;
      color: #fecaca;
    }

    .section-title {
      margin-top: 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #d1d5db;
    }

    .stats-row {
      margin-top: 0.4rem;
      font-size: 0.82rem;
      color: #d1d5db;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .highlight {
      color: #facc15;
      font-weight: 600;
    }

    /* Win/Loss Bar */
    .wl-wrapper {
      margin-top: 0.6rem;
      font-size: 0.8rem;
    }

    .wl-text {
      margin-bottom: 0.2rem;
      color: #d1d5db;
    }

    .wl-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: #1f2937;
      display: flex;
    }

    .wl-segment {
      height: 100%;
    }

    .wl-win {
      background: #16a34a; /* gr√ºn */
    }

    .wl-draw {
      background: #6b7280; /* grau */
    }

    .wl-loss {
      background: #dc2626; /* rot */
    }

    /* Achievements */
    .achievements {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      font-size: 0.75rem;
    }

    .ach-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
      cursor: default;
    }

    .ach-badge.gold {
      border-color: #fbbf24;
      color: #facc15;
    }

    .ach-badge.silver {
      border-color: #9ca3af;
      color: #e5e7eb;
    }

    .ach-badge.bronze {
      border-color: #f97316;
      color: #fed7aa;
    }

    .ach-badge.fail {
      border-color: #ef4444;
      color: #fecaca;
    }

    /* Summary / leaderboards */
    #summary {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .summary-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .summary-card {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 1rem 1.2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      padding: 0.3rem 0.4rem;
      text-align: left;
    }

    th {
      color: #d1d5db;
      border-bottom: 1px solid #1f2937;
    }

    tr:nth-child(even) td {
      background: rgba(15,23,42,0.4);
    }

    .duel-line {
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
      color: #e5e7eb;
    }

    footer {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
    }

    a {
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <main>
    <header style="text-align:center;">
      <h1>‚ôüÔ∏è Chess Activity Dashboard</h1>
      <p class="subtitle" id="subtitle">Lade Daten‚Ä¶</p>
    </header>

    <!-- Player cards -->
    <section class="grid" id="cards"></section>

    <!-- Global leaderboards / duels / overview -->
    <section id="summary"></section>
  </main>

  <footer id="footer"></footer>

  <script>
    const PLAYERS = ["ERR_Daemon", "M41K", "Kathi_2905"];
    const DAYS = 7;
    const MS_PER_DAY = 24 * 60 * 60 * 1000;

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("HTTP " + res.status + " for " + url);
      }
      return res.json();
    }

    async function loadPlayer(username) {
      const uname = username.toLowerCase();
      const nowMs = Date.now();
      const thresholdMs = nowMs - DAYS * MS_PER_DAY;

      let games = [];
      let wins = 0;
      let losses = 0;
      let draws = 0;
      const timeControls = {};

      // --- Spiele der letzten X Tage ---
      try {
        const archivesData = await fetchJson(`https://api.chess.com/pub/player/${uname}/games/archives`);
        const archives = archivesData.archives || [];
        const recentArchives = archives.slice(-3);

        for (const url of recentArchives) {
          try {
            const data = await fetchJson(url);
            (data.games || []).forEach(g => {
              if (!g.end_time) return;
              const endMs = g.end_time * 1000;
              if (endMs < thresholdMs) return;

              const whiteUser = g.white && g.white.username;
              const blackUser = g.black && g.black.username;
              const whiteResult = g.white && g.white.result;
              const blackResult = g.black && g.black.result;

              const isWhite = whiteUser && whiteUser.toLowerCase() === uname;
              const isBlack = blackUser && blackUser.toLowerCase() === uname;

              if (!isWhite && !isBlack) return;

              let myResult = isWhite ? whiteResult : blackResult;
              let oppResult = isWhite ? blackResult : whiteResult;
              let outcome = "draw";

              if (myResult === "win") {
                wins++;
                outcome = "win";
              } else if (oppResult === "win") {
                losses++;
                outcome = "loss";
              } else {
                draws++;
                outcome = "draw";
              }

              const tc = g.time_class || "unknown";
              timeControls[tc] = (timeControls[tc] || 0) + 1;

              games.push({
                endMs,
                time_class: tc,
                rated: g.rated,
                white: whiteUser,
                black: blackUser,
                url: g.url,
                result: outcome
              });
            });
          } catch (e) {
            console.error("Archiv-Fehler f√ºr", username, e);
          }
        }

        games.sort((a, b) => b.endMs - a.endMs);
      } catch (e) {
        console.error("Fehler beim Laden der Archives f√ºr", username, e);
      }

      // --- Taktik-Stats ---
      let tacticsCurrent = null;
      let tacticsHigh = null;
      let tacticsLow = null;

      try {
        const stats = await fetchJson(`https://api.chess.com/pub/player/${uname}/stats`);
        const tactics = stats.tactics;
        if (tactics) {
          const last = tactics.last || {};
          const highest = tactics.highest || {};
          const lowest = tactics.lowest || {};

          tacticsCurrent = (last.rating != null)
            ? last.rating
            : (highest.rating != null ? highest.rating : null);
          tacticsHigh = highest.rating ?? null;
          tacticsLow = lowest.rating ?? null;
        }
      } catch (e) {
        console.error("Fehler beim Laden der Stats f√ºr", username, e);
      }

      // --- Streak-Berechnung (innerhalb der letzten DAYS) ---
      const dayActive = new Array(DAYS).fill(false);
      const nowMs2 = Date.now();
      for (const g of games) {
        const diff = nowMs2 - g.endMs;
        if (diff < 0) continue;
        const idx = Math.floor(diff / MS_PER_DAY);
        if (idx >= 0 && idx < DAYS) {
          dayActive[idx] = true;
        }
      }

      let streakCurrent = 0;
      for (let i = 0; i < DAYS; i++) {
        if (dayActive[i]) streakCurrent++;
        else break;
      }

      let streakLongest = 0;
      let cur = 0;
      for (let i = 0; i < DAYS; i++) {
        if (dayActive[i]) {
          cur++;
          if (cur > streakLongest) streakLongest = cur;
        } else {
          cur = 0;
        }
      }

      const totalGames = wins + losses + draws;
      const winRate = totalGames ? Math.round((wins / totalGames) * 100) : 0;

      // Momentum (letzte bis zu 10 Spiele)
      let momentumScore = 0;
      const recentForMomentum = games.slice(0, 10);
      for (const g of recentForMomentum) {
        if (g.result === "win") momentumScore++;
        else if (g.result === "loss") momentumScore--;
      }

      let momentumLabel = "Neutral";
      let momentumEmoji = "üòê";
      if (momentumScore >= 3) {
        momentumLabel = "Uptrend";
        momentumEmoji = "üöÄ";
      } else if (momentumScore <= -3) {
        momentumLabel = "Downtrend";
        momentumEmoji = "‚ö†Ô∏è";
      } else if (momentumScore > 0) {
        momentumLabel = "Leicht positiv";
        momentumEmoji = "üìà";
      } else if (momentumScore < 0) {
        momentumLabel = "Leicht negativ";
        momentumEmoji = "üìâ";
      }

      return {
        username,
        games,
        wins,
        losses,
        draws,
        totalGames,
        winRate,
        timeControls,
        streakCurrent,
        streakLongest,
        tacticsCurrent,
        tacticsHigh,
        tacticsLow,
        momentumScore,
        momentumLabel,
        momentumEmoji
      };
    }

    function renderWLBar(parent, player) {
      const { wins, losses, draws, totalGames, winRate } = player;
      const wrapper = document.createElement("div");
      wrapper.className = "wl-wrapper";

      if (!totalGames) {
        wrapper.textContent = "Keine Partien im Zeitraum ‚Äì keine Winrate.";
        parent.appendChild(wrapper);
        return;
      }

      const winPct = Math.round((wins / totalGames) * 100);
      const lossPct = Math.round((losses / totalGames) * 100);
      const drawPct = 100 - winPct - lossPct;

      const text = document.createElement("div");
      text.className = "wl-text";
      text.textContent =
        `Wins: ${wins} ¬∑ Losses: ${losses} ¬∑ Draws: ${draws} ¬∑ Winrate: ${winRate}%`;

      const bar = document.createElement("div");
      bar.className = "wl-bar";

      const winSeg = document.createElement("div");
      winSeg.className = "wl-segment wl-win";
      winSeg.style.width = winPct + "%";

      const drawSeg = document.createElement("div");
      drawSeg.className = "wl-segment wl-draw";
      drawSeg.style.width = drawPct + "%";

      const lossSeg = document.createElement("div");
      lossSeg.className = "wl-segment wl-loss";
      lossSeg.style.width = lossPct + "%";

      bar.appendChild(winSeg);
      bar.appendChild(drawSeg);
      bar.appendChild(lossSeg);

      wrapper.appendChild(text);
      wrapper.appendChild(bar);
      parent.appendChild(wrapper);
    }

    // --- Achievements (gleich wie vorher, aber wir zeigen nur eine Handvoll) ---
    function buildAchievements(player) {
      const {
        totalGames,
        wins,
        losses,
        draws,
        winRate,
        tacticsCurrent,
        streakCurrent,
        streakLongest
      } = player;

      const achievements = [];

      if (totalGames === 0) {
        achievements.push({
          label: "üò¥ AFK",
          desc: "Keine Partien in diesem Zeitraum. H√∂chste Zeit, wieder zu spielen!",
          style: "fail"
        });
      } else {
        if (totalGames >= 20) {
          achievements.push({
            label: "üèÉ Ultra Grinder",
            desc: `${totalGames} Partien in ${DAYS} Tagen.`,
            style: "gold"
          });
        } else if (totalGames >= 10) {
          achievements.push({
            label: "üèÉ Grinder",
            desc: `${totalGames} Partien in ${DAYS} Tagen.`,
            style: "silver"
          });
        } else if (totalGames >= 5) {
          achievements.push({
            label: "üéØ Warmgelaufen",
            desc: `${totalGames} Partien in ${DAYS} Tagen.`,
            style: "bronze"
          });
        }
      }

      if (totalGames >= 3) {
        if (winRate >= 70) {
          achievements.push({
            label: "üî• On Fire",
            desc: `Winrate ${winRate}% in diesem Zeitraum.`,
            style: "gold"
          });
        } else if (winRate >= 55) {
          achievements.push({
            label: "üí™ Climber",
            desc: `Winrate ${winRate}% ‚Äì Elo-Klettertour.`,
            style: "silver"
          });
        } else if (winRate <= 35) {
          achievements.push({
            label: "ü©π Tilt Alert",
            desc: `Winrate nur ${winRate}%.`,
            style: "fail"
          });
        }
      }

      if (draws >= 3) {
        achievements.push({
          label: "üß± Solid Wall",
          desc: `${draws} Remis ‚Äì schwer zu knacken.`,
          style: "bronze"
        });
      }

      if (streakCurrent >= 3) {
        achievements.push({
          label: "üìÜ Streaker",
          desc: `Aktuelle Streak: ${streakCurrent} Tage.`,
          style: "silver"
        });
      } else if (streakLongest >= 4) {
        achievements.push({
          label: "üèÖ Streak Legacy",
          desc: `Beste Streak in diesem Zeitraum: ${streakLongest} Tage.`,
          style: "bronze"
        });
      }

      if (tacticsCurrent != null) {
        if (tacticsCurrent >= 2200) {
          achievements.push({
            label: "üß† Tactics Monster",
            desc: `Taktikwertung ${tacticsCurrent}.`,
            style: "gold"
          });
        } else if (tacticsCurrent >= 1800) {
          achievements.push({
            label: "üß† Tactics Pro",
            desc: `Taktikwertung ${tacticsCurrent}.`,
            style: "silver"
          });
        } else if (tacticsCurrent >= 1400) {
          achievements.push({
            label: "üß© Student",
            desc: `Taktikwertung ${tacticsCurrent}.`,
            style: "bronze"
          });
        }
      }

      return achievements;
    }

    function renderAchievements(parent, player) {
      const achievements = buildAchievements(player);

      const title = document.createElement("div");
      title.className = "section-title";
      title.textContent = "üèÖ Achievements";
      parent.appendChild(title);

      const container = document.createElement("div");
      container.className = "achievements";

      if (achievements.length === 0) {
        const empty = document.createElement("div");
        empty.textContent = "Keine besonderen Achievements in diesem Zeitraum.";
        empty.style.fontSize = "0.75rem";
        empty.style.color = "#9ca3af";
        container.appendChild(empty);
      } else {
        // Nur die wichtigsten / ersten 3 anzeigen
        achievements.slice(0, 3).forEach(a => {
          const span = document.createElement("span");
          span.className = `ach-badge ${a.style}`;
          span.textContent = a.label;
          span.title = a.desc;
          container.appendChild(span);
        });
      }

      parent.appendChild(container);
    }

    function renderCard(player) {
      const cards = document.getElementById("cards");

      const card = document.createElement("div");
      card.className = "card";

      const header = document.createElement("div");
      header.className = "card-header";

      const name = document.createElement("div");
      name.className = "username";
      name.textContent = player.username;

      const badge = document.createElement("div");
      const active = player.totalGames > 0;
      badge.className = "badge " + (active ? "active" : "inactive");
      badge.textContent = active ? "AKTIV" : "INAKTIV";

      header.appendChild(name);
      header.appendChild(badge);
      card.appendChild(header);

      // Kompakte Stats
      const stats = document.createElement("div");
      stats.className = "stats-row";

      stats.innerHTML = `
        <div>Partien (letzte ${DAYS} Tage): <span class="highlight">${player.totalGames}</span></div>
        <div>Winrate: <span class="highlight">${player.winRate}%</span> ¬∑ Streak: ${player.streakCurrent} Tag(e)</div>
        <div>Momentum: ${player.momentumEmoji} ${player.momentumLabel}</div>
      `;
      card.appendChild(stats);

      // Win/Loss/Draw Grafik
      renderWLBar(card, player);

      // Taktik kompakt
      const tTitle = document.createElement("div");
      tTitle.className = "section-title";
      tTitle.textContent = "üß† Taktikwertung";
      card.appendChild(tTitle);

      const tDiv = document.createElement("div");
      tDiv.style.fontSize = "0.85rem";
      if (
        player.tacticsCurrent == null &&
        player.tacticsHigh == null &&
        player.tacticsLow == null
      ) {
        tDiv.textContent = "Keine Taktikdaten im API verf√ºgbar.";
      } else {
        tDiv.innerHTML =
          `Aktuell: <span class="highlight">${player.tacticsCurrent ?? "‚Äì"}</span>`;
      }
      card.appendChild(tDiv);

      // Achievements (kompakt, max. 3)
      renderAchievements(card, player);

      cards.appendChild(card);
    }

    // --- Summary / Leaderboards / Duels (wie vorher) ---
    function renderSummary(players) {
      const summary = document.getElementById("summary");
      summary.innerHTML = "";

      // Leaderboard: Spiele
      const gamesCard = document.createElement("div");
      gamesCard.className = "summary-card";
      const gamesTitle = document.createElement("div");
      gamesTitle.className = "summary-title";
      gamesTitle.textContent = "üèÜ Leaderboard ‚Äì gespielte Partien";
      gamesCard.appendChild(gamesTitle);

      const tbl1 = document.createElement("table");
      const h1 = document.createElement("tr");
      h1.innerHTML = "<th>Platz</th><th>Spieler</th><th>Partien</th><th>Winrate</th>";
      tbl1.appendChild(h1);

      [...players]
        .sort((a, b) => b.totalGames - a.totalGames)
        .forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML =
            `<td>${idx + 1}</td><td>${p.username}</td><td>${p.totalGames}</td><td>${p.winRate}%</td>`;
          tbl1.appendChild(tr);
        });

      gamesCard.appendChild(tbl1);
      summary.appendChild(gamesCard);

      // Leaderboard: Winrate (mind. 3 Spiele)
      const winrateCard = document.createElement("div");
      winrateCard.className = "summary-card";
      const winrateTitle = document.createElement("div");
      winrateTitle.className = "summary-title";
      winrateTitle.textContent = "üìà Leaderboard ‚Äì Winrate (min. 3 Partien)";
      winrateCard.appendChild(winrateTitle);

      const tbl2 = document.createElement("table");
      const h2 = document.createElement("tr");
      h2.innerHTML = "<th>Platz</th><th>Spieler</th><th>Winrate</th><th>Partien</th>";
      tbl2.appendChild(h2);

      [...players]
        .filter(p => p.totalGames >= 3)
        .sort((a, b) => b.winRate - a.winRate)
        .forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML =
            `<td>${idx + 1}</td><td>${p.username}</td><td>${p.winRate}%</td><td>${p.totalGames}</td>`;
          tbl2.appendChild(tr);
        });

      if (tbl2.rows.length === 1) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4">Noch zu wenig Partien f√ºr einen fairen Vergleich.</td>`;
        tbl2.appendChild(tr);
      }

      winrateCard.appendChild(tbl2);
      summary.appendChild(winrateCard);

      // Leaderboard: Taktikwertung
      const tacticsCard = document.createElement("div");
      tacticsCard.className = "summary-card";
      const tacticsTitle = document.createElement("div");
      tacticsTitle.className = "summary-title";
      tacticsTitle.textContent = "üß† Leaderboard ‚Äì Taktikwertung";
      tacticsCard.appendChild(tacticsTitle);

      const tbl3 = document.createElement("table");
      const h3 = document.createElement("tr");
      h3.innerHTML = "<th>Platz</th><th>Spieler</th><th>Aktuell</th>";
      tbl3.appendChild(h3);

      const withTactics = players.filter(p => p.tacticsCurrent != null);
      withTactics
        .sort((a, b) => b.tacticsCurrent - a.tacticsCurrent)
        .forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML =
            `<td>${idx + 1}</td><td>${p.username}</td><td>${p.tacticsCurrent}</td>`;
          tbl3.appendChild(tr);
        });

      if (!withTactics.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3">Keine Taktikdaten f√ºr jemanden verf√ºgbar.</td>`;
        tbl3.appendChild(tr);
      }

      tacticsCard.appendChild(tbl3);
      summary.appendChild(tacticsCard);

      // Duelle
      const duelCard = document.createElement("div");
      duelCard.className = "summary-card";
      const duelTitle = document.createElement("div");
      duelTitle.className = "summary-title";
      duelTitle.textContent = "‚öîÔ∏è Duelle ‚Äì Wer dominiert die Woche?";
      duelCard.appendChild(duelTitle);

      for (let i = 0; i < players.length; i++) {
        for (let j = i + 1; j < players.length; j++) {
          const a = players[i];
          const b = players[j];

          let scoreA = 0;
          let scoreB = 0;

          if (a.totalGames > b.totalGames) scoreA++;
          else if (b.totalGames > a.totalGames) scoreB++;

          if (a.totalGames >= 3 && b.totalGames >= 3) {
            if (a.winRate > b.winRate) scoreA++;
            else if (b.winRate > a.winRate) scoreB++;
          }

          if (a.tacticsCurrent != null && b.tacticsCurrent != null) {
            if (a.tacticsCurrent > b.tacticsCurrent) scoreA++;
            else if (b.tacticsCurrent > a.tacticsCurrent) scoreB++;
          }

          let resultText = "";
          if (scoreA > scoreB) {
            resultText = `üëë ${a.username} f√ºhrt gegen ${b.username} (${scoreA} : ${scoreB})`;
          } else if (scoreB > scoreA) {
            resultText = `üëë ${b.username} f√ºhrt gegen ${a.username} (${scoreB} : ${scoreA})`;
          } else {
            resultText = `ü§ù ${a.username} und ${b.username} sind im Gleichstand (${scoreA} : ${scoreB}).`;
          }

          const line = document.createElement("div");
          line.className = "duel-line";
          line.textContent = resultText;
          duelCard.appendChild(line);
        }
      }

      summary.appendChild(duelCard);
    }

    async function init() {
      const subtitle = document.getElementById("subtitle");
      subtitle.textContent = "Lade Daten direkt von chess.com‚Ä¶";

      const players = await Promise.all(PLAYERS.map(loadPlayer));

      players.forEach(p => renderCard(p));
      renderSummary(players);

      const now = new Date();
      subtitle.textContent =
        `Zeitraum: letzte ${DAYS} Tage ¬∑ Stand: ${now.toLocaleString()}`;

      const footer = document.getElementById("footer");
      footer.innerHTML =
        `Datenquelle: <a href="https://www.chess.com/news/view/published-data-api" target="_blank" rel="noreferrer">Chess.com Published Data API</a>`;
    }

    init();
  </script>
</body>
</html>
