<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Chess Activity ‚Äì err_daemon, m41k, Kathi_2905</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
    }

    h1 {
      margin: 0;
      font-size: 2rem;
      text-align: center;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 0.9rem;
      text-align: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      width: 100%;
      max-width: 960px;
    }

    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 1rem;
      padding: 1.2rem 1.4rem;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .username {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .badge {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge.active {
      background: #065f46;
      color: #bbf7d0;
    }

    .badge.inactive {
      background: #7f1d1d;
      color: #fecaca;
    }

    .section-title {
      margin-top: 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #d1d5db;
    }

    .games-list {
      margin: 0.4rem 0 0;
      padding-left: 1rem;
      font-size: 0.82rem;
      color: #9ca3af;
    }

    .games-list li {
      margin-bottom: 0.3rem;
    }

    .tactics {
      font-size: 0.88rem;
      margin-top: 0.3rem;
    }

    .highlight {
      color: #facc15;
      font-weight: 600;
    }

    footer {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
    }

    a {
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <main>
    <h1>‚ôüÔ∏è Chess Activity Dashboard</h1>
    <p class="subtitle" id="subtitle">Lade Daten‚Ä¶</p>

    <div class="grid" id="cards"></div>
  </main>

  <footer id="footer"></footer>

  <script>
    const PLAYERS = ["err_daemon", "m41k", "Kathi_2905"];
    const DAYS = 2;

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("HTTP " + res.status + " for " + url);
      }
      return res.json();
    }

    async function loadPlayer(username) {
      const uname = username.toLowerCase();

      // --- Spiele der letzten X Tage ---
      let games = [];
      try {
        const archivesData = await fetchJson(`https://api.chess.com/pub/player/${uname}/games/archives`);
        const archives = archivesData.archives || [];
        const recentArchives = archives.slice(-3); // letzte 3 Monate um Monatswechsel abzudecken

        const nowMs = Date.now();
        const thresholdMs = nowMs - DAYS * 24 * 60 * 60 * 1000;

        for (const url of recentArchives) {
          try {
            const data = await fetchJson(url);
            (data.games || []).forEach(g => {
              if (!g.end_time) return;
              const endMs = g.end_time * 1000;
              if (endMs >= thresholdMs) {
                games.push({
                  endMs,
                  time_class: g.time_class,
                  rated: g.rated,
                  white: g.white && g.white.username,
                  black: g.black && g.black.username,
                  url: g.url
                });
              }
            });
          } catch (e) {
            console.error("Archiv-Fehler f√ºr", username, e);
          }
        }

        games.sort((a, b) => b.endMs - a.endMs);
      } catch (e) {
        console.error("Fehler beim Laden der Archives f√ºr", username, e);
      }

      // --- Taktik-Stats ---
      let tacticsCurrent = null;
      let tacticsHigh = null;
      let tacticsLow = null;

      try {
        const stats = await fetchJson(`https://api.chess.com/pub/player/${uname}/stats`);
        const tactics = stats.tactics;
        if (tactics) {
          const last = tactics.last || {};
          const highest = tactics.highest || {};
          const lowest = tactics.lowest || {};

          tacticsCurrent = (last.rating != null) ? last.rating :
                           (highest.rating != null ? highest.rating : null);
          tacticsHigh = highest.rating ?? null;
          tacticsLow = lowest.rating ?? null;
        }
      } catch (e) {
        console.error("Fehler beim Laden der Stats f√ºr", username, e);
      }

      renderCard({
        username,
        games,
        tacticsCurrent,
        tacticsHigh,
        tacticsLow
      });
    }

    function renderCard(player) {
      const cards = document.getElementById("cards");

      const card = document.createElement("div");
      card.className = "card";

      const header = document.createElement("div");
      header.className = "card-header";

      const name = document.createElement("div");
      name.className = "username";
      name.textContent = player.username;

      const badge = document.createElement("div");
      const active = player.games.length > 0;
      badge.className = "badge " + (active ? "active" : "inactive");
      badge.textContent = active ? "AKTIV" : "INAKTIV";

      header.appendChild(name);
      header.appendChild(badge);
      card.appendChild(header);

      // Spiele
      const gTitle = document.createElement("div");
      gTitle.className = "section-title";
      gTitle.textContent = "üïí Partien (letzte " + DAYS + " Tage)";
      card.appendChild(gTitle);

      if (!active) {
        const noGames = document.createElement("div");
        noGames.style.fontSize = "0.85rem";
        noGames.style.color = "#f87171";
        noGames.textContent = "Keine beendeten Partien. Zeit, wieder zu spielen, bevor der Skill rostet! üî•";
        card.appendChild(noGames);
      } else {
        const ul = document.createElement("ul");
        ul.className = "games-list";

        player.games.slice(0, 5).forEach(g => {
          const li = document.createElement("li");
          const date = new Date(g.endMs);
          const rated = g.rated ? "Rated" : "Unrated";
          li.innerHTML =
            `<span>${date.toLocaleString()} ‚Äì ${g.time_class}, ${rated}</span><br>` +
            `<span>${g.white} vs ${g.black}</span>`;
          ul.appendChild(li);
        });

        card.appendChild(ul);
      }

      // Taktiken
      const tTitle = document.createElement("div");
      tTitle.className = "section-title";
      tTitle.textContent = "üß† Taktikwertung";
      card.appendChild(tTitle);

      const tDiv = document.createElement("div");
      tDiv.className = "tactics";

      if (
        player.tacticsCurrent == null &&
        player.tacticsHigh == null &&
        player.tacticsLow == null
      ) {
        tDiv.textContent = "Keine Taktikdaten im API verf√ºgbar.";
      } else {
        tDiv.innerHTML =
          `Aktuell: <span class="highlight">${player.tacticsCurrent ?? "‚Äì"}</span><br>` +
          `Highest: ${player.tacticsHigh ?? "‚Äì"} ¬∑ Lowest: ${player.tacticsLow ?? "‚Äì"}`;
      }

      card.appendChild(tDiv);

      cards.appendChild(card);
    }

    async function init() {
      const subtitle = document.getElementById("subtitle");
      subtitle.textContent = "Lade Daten direkt von chess.com‚Ä¶";

      await Promise.all(PLAYERS.map(loadPlayer));

      const now = new Date();
      subtitle.textContent = `Fenster: letzte ${DAYS} Tage ¬∑ Stand: ${now.toLocaleString()}`;

      const footer = document.getElementById("footer");
      footer.innerHTML =
        `Datenquelle: <a href="https://www.chess.com/news/view/published-data-api" target="_blank" rel="noreferrer">Chess.com Published Data API</a>`;
    }

    init();
  </script>
</body>
</html>
